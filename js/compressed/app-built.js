$(function(){var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function n(e,t){var n,r,i,o,a,s,u,l,c,h,f=t&&t.split("/"),d=g.map,p=d&&d["*"]||{};if(e&&"."===e.charAt(0))if(t){for(f=f.slice(0,f.length-1),e=f.concat(e.split("/")),l=0;l<e.length;l+=1)if(h=e[l],"."===h)e.splice(l,1),l-=1;else if(".."===h){if(1===l&&(".."===e[2]||".."===e[0]))break;l>0&&(e.splice(l-1,2),l-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((f||p)&&d){for(n=e.split("/"),l=n.length;l>0;l-=1){if(r=n.slice(0,l).join("/"),f)for(c=f.length;c>0;c-=1)if(i=d[f.slice(0,c).join("/")],i&&(i=i[r])){o=i,a=l;break}if(o)break;!s&&p&&p[r]&&(s=p[r],u=l)}!o&&s&&(o=s,a=u),o&&(n.splice(0,a,o),e=n.join("/"))}return e}function r(t,n){return function(){return c.apply(e,y.call(arguments,0).concat([t,n]))}}function i(e){return function(t){return n(t,e)}}function o(e){return function(t){d[e]=t}}function a(n){if(t(p,n)){var r=p[n];delete p[n],m[n]=!0,l.apply(e,r)}if(!t(d,n)&&!t(m,n))throw new Error("No "+n);return d[n]}function s(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function u(e){return function(){return g&&g.config&&g.config[e]||{}}}var l,c,h,f,d={},p={},g={},m={},v=Object.prototype.hasOwnProperty,y=[].slice;h=function(e,t){var r,o=s(e),u=o[0];return e=o[1],u&&(u=n(u,t),r=a(u)),u?e=r&&r.normalize?r.normalize(e,i(t)):n(e,t):(e=n(e,t),o=s(e),u=o[0],e=o[1],u&&(r=a(u))),{f:u?u+"!"+e:e,n:e,pr:u,p:r}},f={require:function(e){return r(e)},exports:function(e){var t=d[e];return"undefined"!=typeof t?t:d[e]={}},module:function(e){return{id:e,uri:"",exports:d[e],config:u(e)}}},l=function(n,i,s,u){var l,c,g,v,y,b,_=[];if(u=u||n,"function"==typeof s){for(i=!i.length&&s.length?["require","exports","module"]:i,y=0;y<i.length;y+=1)if(v=h(i[y],u),c=v.f,"require"===c)_[y]=f.require(n);else if("exports"===c)_[y]=f.exports(n),b=!0;else if("module"===c)l=_[y]=f.module(n);else if(t(d,c)||t(p,c)||t(m,c))_[y]=a(c);else{if(!v.p)throw new Error(n+" missing "+c);v.p.load(v.n,r(u,!0),o(c),{}),_[y]=d[c]}g=s.apply(d[n],_),n&&(l&&l.exports!==e&&l.exports!==d[n]?d[n]=l.exports:g===e&&b||(d[n]=g))}else n&&(d[n]=s)},requirejs=require=c=function(t,n,r,i,o){return"string"==typeof t?f[t]?f[t](n):a(h(t,n).f):(t.splice||(g=t,n.splice?(t=n,n=r,r=null):t=e),n=n||function(){},"function"==typeof r&&(r=i,i=o),i?l(e,t,n,r):setTimeout(function(){l(e,t,n,r)},4),c)},c.config=function(e){return g=e,g.deps&&c(g.deps,g.callback),c},define=function(e,n,r){n.splice||(r=n,n=[]),t(d,e)||t(p,e)||(p[e]=[e,n,r])},define.amd={jQuery:!0}}(),define("libs/almond/almond.js",function(){}),define("jQuery",[],function(){return window.jQuery}),function(){function e(t,n,r){if(t===n)return 0!==t||1/t==1/n;if(null==t||null==n)return t===n;if(t._chain&&(t=t._wrapped),n._chain&&(n=n._wrapped),t.isEqual&&w.isFunction(t.isEqual))return t.isEqual(n);if(n.isEqual&&w.isFunction(n.isEqual))return n.isEqual(t);var i=u.call(t);if(i!=u.call(n))return!1;switch(i){case"[object String]":return t==""+n;case"[object Number]":return t!=+t?n!=+n:0==t?1/t==1/n:t==+n;case"[object Date]":case"[object Boolean]":return+t==+n;case"[object RegExp]":return t.source==n.source&&t.global==n.global&&t.multiline==n.multiline&&t.ignoreCase==n.ignoreCase}if("object"!=typeof t||"object"!=typeof n)return!1;for(var o=r.length;o--;)if(r[o]==t)return!0;r.push(t);var o=0,a=!0;if("[object Array]"==i){if(o=t.length,a=o==n.length)for(;o--&&(a=o in t==o in n&&e(t[o],n[o],r)););}else{if("constructor"in t!="constructor"in n||t.constructor!=n.constructor)return!1;for(var s in t)if(w.has(t,s)&&(o++,!(a=w.has(n,s)&&e(t[s],n[s],r))))break;if(a){for(s in n)if(w.has(n,s)&&!o--)break;a=!o}}return r.pop(),a}var t=this,n=t._,r={},i=Array.prototype,o=Object.prototype,a=i.slice,s=i.unshift,u=o.toString,l=o.hasOwnProperty,c=i.forEach,h=i.map,f=i.reduce,d=i.reduceRight,p=i.filter,g=i.every,m=i.some,v=i.indexOf,y=i.lastIndexOf,o=Array.isArray,b=Object.keys,_=Function.prototype.bind,w=function(e){return new T(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=w),exports._=w):t._=w,w.VERSION="1.3.3";var x=w.each=w.forEach=function(e,t,n){if(null!=e)if(c&&e.forEach===c)e.forEach(t,n);else if(e.length===+e.length)for(var i=0,o=e.length;o>i&&!(i in e&&t.call(n,e[i],i,e)===r);i++);else for(i in e)if(w.has(e,i)&&t.call(n,e[i],i,e)===r)break};w.map=w.collect=function(e,t,n){var r=[];return null==e?r:h&&e.map===h?e.map(t,n):(x(e,function(e,i,o){r[r.length]=t.call(n,e,i,o)}),e.length===+e.length&&(r.length=e.length),r)},w.reduce=w.foldl=w.inject=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),f&&e.reduce===f)return r&&(t=w.bind(t,r)),i?e.reduce(t,n):e.reduce(t);if(x(e,function(e,o,a){i?n=t.call(r,n,e,o,a):(n=e,i=!0)}),!i)throw new TypeError("Reduce of empty array with no initial value");return n},w.reduceRight=w.foldr=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),d&&e.reduceRight===d)return r&&(t=w.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var o=w.toArray(e).reverse();return r&&!i&&(t=w.bind(t,r)),i?w.reduce(o,t,n,r):w.reduce(o,t)},w.find=w.detect=function(e,t,n){var r;return k(e,function(e,i,o){return t.call(n,e,i,o)?(r=e,!0):void 0}),r},w.filter=w.select=function(e,t,n){var r=[];return null==e?r:p&&e.filter===p?e.filter(t,n):(x(e,function(e,i,o){t.call(n,e,i,o)&&(r[r.length]=e)}),r)},w.reject=function(e,t,n){var r=[];return null==e?r:(x(e,function(e,i,o){t.call(n,e,i,o)||(r[r.length]=e)}),r)},w.every=w.all=function(e,t,n){var i=!0;return null==e?i:g&&e.every===g?e.every(t,n):(x(e,function(e,o,a){return(i=i&&t.call(n,e,o,a))?void 0:r}),!!i)};var k=w.some=w.any=function(e,t,n){t||(t=w.identity);var i=!1;return null==e?i:m&&e.some===m?e.some(t,n):(x(e,function(e,o,a){return i||(i=t.call(n,e,o,a))?r:void 0}),!!i)};w.include=w.contains=function(e,t){var n=!1;return null==e?n:v&&e.indexOf===v?-1!=e.indexOf(t):n=k(e,function(e){return e===t})},w.invoke=function(e,t){var n=a.call(arguments,2);return w.map(e,function(e){return(w.isFunction(t)?t||e:e[t]).apply(e,n)})},w.pluck=function(e,t){return w.map(e,function(e){return e[t]})},w.max=function(e,t,n){if(!t&&w.isArray(e)&&e[0]===+e[0])return Math.max.apply(Math,e);if(!t&&w.isEmpty(e))return-1/0;var r={computed:-1/0};return x(e,function(e,i,o){i=t?t.call(n,e,i,o):e,i>=r.computed&&(r={value:e,computed:i})}),r.value},w.min=function(e,t,n){if(!t&&w.isArray(e)&&e[0]===+e[0])return Math.min.apply(Math,e);if(!t&&w.isEmpty(e))return 1/0;var r={computed:1/0};return x(e,function(e,i,o){i=t?t.call(n,e,i,o):e,i<r.computed&&(r={value:e,computed:i})}),r.value},w.shuffle=function(e){var t,n=[];return x(e,function(e,r){t=Math.floor(Math.random()*(r+1)),n[r]=n[t],n[t]=e}),n},w.sortBy=function(e,t,n){var r=w.isFunction(t)?t:function(e){return e[t]};return w.pluck(w.map(e,function(e,t,i){return{value:e,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return void 0===n?1:void 0===r?-1:r>n?-1:n>r?1:0}),"value")},w.groupBy=function(e,t){var n={},r=w.isFunction(t)?t:function(e){return e[t]};return x(e,function(e,t){var i=r(e,t);(n[i]||(n[i]=[])).push(e)}),n},w.sortedIndex=function(e,t,n){n||(n=w.identity);for(var r=0,i=e.length;i>r;){var o=r+i>>1;n(e[o])<n(t)?r=o+1:i=o}return r},w.toArray=function(e){return e?w.isArray(e)||w.isArguments(e)?a.call(e):e.toArray&&w.isFunction(e.toArray)?e.toArray():w.values(e):[]},w.size=function(e){return w.isArray(e)?e.length:w.keys(e).length},w.first=w.head=w.take=function(e,t,n){return null==t||n?e[0]:a.call(e,0,t)},w.initial=function(e,t,n){return a.call(e,0,e.length-(null==t||n?1:t))},w.last=function(e,t,n){return null==t||n?e[e.length-1]:a.call(e,Math.max(e.length-t,0))},w.rest=w.tail=function(e,t,n){return a.call(e,null==t||n?1:t)},w.compact=function(e){return w.filter(e,function(e){return!!e})},w.flatten=function(e,t){return w.reduce(e,function(e,n){return w.isArray(n)?e.concat(t?n:w.flatten(n)):(e[e.length]=n,e)},[])},w.without=function(e){return w.difference(e,a.call(arguments,1))},w.uniq=w.unique=function(e,t,n){var n=n?w.map(e,n):e,r=[];return e.length<3&&(t=!0),w.reduce(n,function(n,i,o){return(t?w.last(n)===i&&n.length:w.include(n,i))||(n.push(i),r.push(e[o])),n},[]),r},w.union=function(){return w.uniq(w.flatten(arguments,!0))},w.intersection=w.intersect=function(e){var t=a.call(arguments,1);return w.filter(w.uniq(e),function(e){return w.every(t,function(t){return w.indexOf(t,e)>=0})})},w.difference=function(e){var t=w.flatten(a.call(arguments,1),!0);return w.filter(e,function(e){return!w.include(t,e)})},w.zip=function(){for(var e=a.call(arguments),t=w.max(w.pluck(e,"length")),n=Array(t),r=0;t>r;r++)n[r]=w.pluck(e,""+r);return n},w.indexOf=function(e,t,n){if(null==e)return-1;var r;if(n)return n=w.sortedIndex(e,t),e[n]===t?n:-1;if(v&&e.indexOf===v)return e.indexOf(t);for(n=0,r=e.length;r>n;n++)if(n in e&&e[n]===t)return n;return-1},w.lastIndexOf=function(e,t){if(null==e)return-1;if(y&&e.lastIndexOf===y)return e.lastIndexOf(t);for(var n=e.length;n--;)if(n in e&&e[n]===t)return n;return-1},w.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0);for(var n=arguments[2]||1,r=Math.max(Math.ceil((t-e)/n),0),i=0,o=Array(r);r>i;)o[i++]=e,e+=n;return o};var S=function(){};w.bind=function(e,t){var n,r;if(e.bind===_&&_)return _.apply(e,a.call(arguments,1));if(!w.isFunction(e))throw new TypeError;return r=a.call(arguments,2),n=function(){if(!(this instanceof n))return e.apply(t,r.concat(a.call(arguments)));S.prototype=e.prototype;var i=new S,o=e.apply(i,r.concat(a.call(arguments)));return Object(o)===o?o:i}},w.bindAll=function(e){var t=a.call(arguments,1);return 0==t.length&&(t=w.functions(e)),x(t,function(t){e[t]=w.bind(e[t],e)}),e},w.memoize=function(e,t){var n={};return t||(t=w.identity),function(){var r=t.apply(this,arguments);return w.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},w.delay=function(e,t){var n=a.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},w.defer=function(e){return w.delay.apply(w,[e,1].concat(a.call(arguments,1)))},w.throttle=function(e,t){var n,r,i,o,a,s,u=w.debounce(function(){a=o=!1},t);return function(){return n=this,r=arguments,i||(i=setTimeout(function(){i=null,a&&e.apply(n,r),u()},t)),o?a=!0:s=e.apply(n,r),u(),o=!0,s}},w.debounce=function(e,t,n){var r;return function(){var i=this,o=arguments;n&&!r&&e.apply(i,o),clearTimeout(r),r=setTimeout(function(){r=null,n||e.apply(i,o)},t)}},w.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments))}},w.wrap=function(e,t){return function(){var n=[e].concat(a.call(arguments,0));return t.apply(this,n)}},w.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},w.after=function(e,t){return 0>=e?t():function(){return--e<1?t.apply(this,arguments):void 0}},w.keys=b||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t,n=[];for(t in e)w.has(e,t)&&(n[n.length]=t);return n},w.values=function(e){return w.map(e,w.identity)},w.functions=w.methods=function(e){var t,n=[];for(t in e)w.isFunction(e[t])&&n.push(t);return n.sort()},w.extend=function(e){return x(a.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},w.pick=function(e){var t={};return x(w.flatten(a.call(arguments,1)),function(n){n in e&&(t[n]=e[n])}),t},w.defaults=function(e){return x(a.call(arguments,1),function(t){for(var n in t)null==e[n]&&(e[n]=t[n])}),e},w.clone=function(e){return w.isObject(e)?w.isArray(e)?e.slice():w.extend({},e):e},w.tap=function(e,t){return t(e),e},w.isEqual=function(t,n){return e(t,n,[])},w.isEmpty=function(e){if(null==e)return!0;if(w.isArray(e)||w.isString(e))return 0===e.length;for(var t in e)if(w.has(e,t))return!1;return!0},w.isElement=function(e){return!(!e||1!=e.nodeType)},w.isArray=o||function(e){return"[object Array]"==u.call(e)},w.isObject=function(e){return e===Object(e)},w.isArguments=function(e){return"[object Arguments]"==u.call(e)},w.isArguments(arguments)||(w.isArguments=function(e){return!(!e||!w.has(e,"callee"))}),w.isFunction=function(e){return"[object Function]"==u.call(e)},w.isString=function(e){return"[object String]"==u.call(e)},w.isNumber=function(e){return"[object Number]"==u.call(e)},w.isFinite=function(e){return w.isNumber(e)&&isFinite(e)},w.isNaN=function(e){return e!==e},w.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==u.call(e)},w.isDate=function(e){return"[object Date]"==u.call(e)},w.isRegExp=function(e){return"[object RegExp]"==u.call(e)},w.isNull=function(e){return null===e},w.isUndefined=function(e){return void 0===e},w.has=function(e,t){return l.call(e,t)},w.noConflict=function(){return t._=n,this},w.identity=function(e){return e},w.times=function(e,t,n){for(var r=0;e>r;r++)t.call(n,r)},w.escape=function(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},w.result=function(e,t){if(null==e)return null;var n=e[t];return w.isFunction(n)?n.call(e):n},w.mixin=function(e){x(w.functions(e),function(t){M(t,w[t]=e[t])})};var E=0;w.uniqueId=function(e){var t=E++;return e?e+t:t},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var j,O=/.^/,A={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(j in A)A[A[j]]=j;var F=/\\|'|\r|\n|\t|\u2028|\u2029/g,B=/\\(\\|'|r|n|t|u2028|u2029)/g,C=function(e){return e.replace(B,function(e,t){return A[t]})};w.template=function(e,t,n){n=w.defaults(n||{},w.templateSettings),e="__p+='"+e.replace(F,function(e){return"\\"+A[e]}).replace(n.escape||O,function(e,t){return"'+\n_.escape("+C(t)+")+\n'"}).replace(n.interpolate||O,function(e,t){return"'+\n("+C(t)+")+\n'"}).replace(n.evaluate||O,function(e,t){return"';\n"+C(t)+"\n;__p+='"})+"';\n",n.variable||(e="with(obj||{}){\n"+e+"}\n");var e="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+e+"return __p;\n",r=new Function(n.variable||"obj","_",e);return t?r(t,w):(t=function(e){return r.call(this,e,w)},t.source="function("+(n.variable||"obj")+"){\n"+e+"}",t)},w.chain=function(e){return w(e).chain()};var T=function(e){this._wrapped=e};w.prototype=T.prototype;var q=function(e,t){return t?w(e).chain():e},M=function(e,t){T.prototype[e]=function(){var e=a.call(arguments);return s.call(e,this._wrapped),q(t.apply(w,e),this._chain)}};w.mixin(w),x("pop,push,reverse,shift,sort,splice,unshift".split(","),function(e){var t=i[e];T.prototype[e]=function(){var n=this._wrapped;t.apply(n,arguments);var r=n.length;return("shift"==e||"splice"==e)&&0===r&&delete n[0],q(n,this._chain)}}),x(["concat","join","slice"],function(e){var t=i[e];T.prototype[e]=function(){return q(t.apply(this._wrapped,arguments),this._chain)}}),T.prototype.chain=function(){return this._chain=!0,this},T.prototype.value=function(){return this._wrapped}}.call(window),define("libs/underscore-min",function(){}),define("Underscore",["!libs/underscore-min"],function(){return window._}),function(){var e,t=this,n=t.Backbone,r=Array.prototype.slice,i=Array.prototype.splice;e="undefined"!=typeof exports?exports:t.Backbone={},e.VERSION="0.9.2";var o=t._;!o&&"undefined"!=typeof require&&(o=require("underscore"));var a=t.jQuery||t.Zepto||t.ender;e.setDomLibrary=function(e){a=e},e.noConflict=function(){return t.Backbone=n,this},e.emulateHTTP=!1,e.emulateJSON=!1;var s=/\s+/,u=e.Events={on:function(e,t,n){var r,i,o,a,u;if(!t)return this;for(e=e.split(s),r=this._callbacks||(this._callbacks={});i=e.shift();)o=(u=r[i])?u.tail:{},o.next=a={},o.context=n,o.callback=t,r[i]={tail:a,next:u?u.next:o};return this},off:function(e,t,n){var r,i,a,u,l,c;if(i=this._callbacks){if(!e&&!t&&!n)return delete this._callbacks,this;for(e=e?e.split(s):o.keys(i);r=e.shift();)if(a=i[r],delete i[r],a&&(t||n))for(u=a.tail;(a=a.next)!==u;)l=a.callback,c=a.context,(t&&l!==t||n&&c!==n)&&this.on(r,l,c);return this}},trigger:function(e){var t,n,i,o,a,u;if(!(i=this._callbacks))return this;for(a=i.all,e=e.split(s),u=r.call(arguments,1);t=e.shift();){if(n=i[t])for(o=n.tail;(n=n.next)!==o;)n.callback.apply(n.context||this,u);if(n=a)for(o=n.tail,t=[t].concat(u);(n=n.next)!==o;)n.callback.apply(n.context||this,t)}return this}};u.bind=u.on,u.unbind=u.off;var l=e.Model=function(e,t){var n;e||(e={}),t&&t.parse&&(e=this.parse(e)),(n=S(this,"defaults"))&&(e=o.extend({},n,e)),t&&t.collection&&(this.collection=t.collection),this.attributes={},this._escapedAttributes={},this.cid=o.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(e,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=o.clone(this.attributes),this.initialize.apply(this,arguments)};o.extend(l.prototype,u,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(){return o.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var t;return(t=this._escapedAttributes[e])?t:(t=this.get(e),this._escapedAttributes[e]=o.escape(null==t?"":""+t))},has:function(e){return null!=this.get(e)},set:function(e,t,n){var r,i;if(o.isObject(e)||null==e?(r=e,n=t):(r={},r[e]=t),n||(n={}),!r)return this;if(r instanceof l&&(r=r.attributes),n.unset)for(i in r)r[i]=void 0;if(!this._validate(r,n))return!1;this.idAttribute in r&&(this.id=r[this.idAttribute]);var t=n.changes={},a=this.attributes,s=this._escapedAttributes,u=this._previousAttributes||{};for(i in r)e=r[i],(!o.isEqual(a[i],e)||n.unset&&o.has(a,i))&&(delete s[i],(n.silent?this._silent:t)[i]=!0),n.unset?delete a[i]:a[i]=e,o.isEqual(u[i],e)&&o.has(a,i)==o.has(u,i)?(delete this.changed[i],delete this._pending[i]):(this.changed[i]=e,n.silent||(this._pending[i]=!0));return n.silent||this.change(n),this},unset:function(e,t){return(t||(t={})).unset=!0,this.set(e,null,t)},clear:function(e){return(e||(e={})).unset=!0,this.set(o.clone(this.attributes),e)},fetch:function(t){var t=t?o.clone(t):{},n=this,r=t.success;return t.success=function(e,i,o){return n.set(n.parse(e,o),t)?(r&&r(n,e),void 0):!1},t.error=e.wrapError(t.error,n,t),(this.sync||e.sync).call(this,"read",this,t)},save:function(t,n,r){var i,a;if(o.isObject(t)||null==t?(i=t,r=n):(i={},i[t]=n),r=r?o.clone(r):{},r.wait){if(!this._validate(i,r))return!1;a=o.clone(this.attributes)}if(t=o.extend({},r,{silent:!0}),i&&!this.set(i,r.wait?t:r))return!1;var s=this,u=r.success;return r.success=function(e,t,n){return t=s.parse(e,n),r.wait&&(delete r.wait,t=o.extend(i||{},t)),s.set(t,r)?(u?u(s,e):s.trigger("sync",s,e,r),void 0):!1},r.error=e.wrapError(r.error,s,r),n=this.isNew()?"create":"update",n=(this.sync||e.sync).call(this,n,this,r),r.wait&&this.set(a,t),n},destroy:function(t){var t=t?o.clone(t):{},n=this,r=t.success,i=function(){n.trigger("destroy",n,n.collection,t)};if(this.isNew())return i(),!1;t.success=function(e){t.wait&&i(),r?r(n,e):n.trigger("sync",n,e,t)},t.error=e.wrapError(t.error,n,t);var a=(this.sync||e.sync).call(this,"delete",this,t);return t.wait||i(),a},url:function(){var e=S(this,"urlRoot")||S(this.collection,"url")||E();return this.isNew()?e:e+("/"==e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(e){e||(e={});var t=this._changing;this._changing=!0;for(var n in this._silent)this._pending[n]=!0;var r=o.extend({},e.changes,this._silent);this._silent={};for(n in r)this.trigger("change:"+n,this,this.get(n),e);if(t)return this;for(;!o.isEmpty(this._pending);){this._pending={},this.trigger("change",this,e);for(n in this.changed)!this._pending[n]&&!this._silent[n]&&delete this.changed[n];this._previousAttributes=o.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(e){return arguments.length?o.has(this.changed,e):!o.isEmpty(this.changed)},changedAttributes:function(e){if(!e)return this.hasChanged()?o.clone(this.changed):!1;var t,n,r=!1,i=this._previousAttributes;for(n in e)o.isEqual(i[n],t=e[n])||((r||(r={}))[n]=t);return r},previous:function(e){return arguments.length&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return o.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(e,t){if(t.silent||!this.validate)return!0;var e=o.extend({},this.attributes,e),n=this.validate(e,t);return n?(t&&t.error?t.error(this,n,t):this.trigger("error",this,n,t),!1):!0}});var c=e.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})};o.extend(c.prototype,u,{model:l,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},add:function(e,t){var n,r,a,s,u,l={},c={},h=[];for(t||(t={}),e=o.isArray(e)?e.slice():[e],n=0,r=e.length;r>n;n++){if(!(a=e[n]=this._prepareModel(e[n],t)))throw Error("Can't add an invalid model to a collection");s=a.cid,u=a.id,l[s]||this._byCid[s]||null!=u&&(c[u]||this._byId[u])?h.push(n):l[s]=c[u]=a}for(n=h.length;n--;)e.splice(h[n],1);for(n=0,r=e.length;r>n;n++)(a=e[n]).on("all",this._onModelEvent,this),this._byCid[a.cid]=a,null!=a.id&&(this._byId[a.id]=a);if(this.length+=r,i.apply(this.models,[null!=t.at?t.at:this.models.length,0].concat(e)),this.comparator&&this.sort({silent:!0}),t.silent)return this;for(n=0,r=this.models.length;r>n;n++)l[(a=this.models[n]).cid]&&(t.index=n,a.trigger("add",a,this,t));return this},remove:function(e,t){var n,r,i,a;for(t||(t={}),e=o.isArray(e)?e.slice():[e],n=0,r=e.length;r>n;n++)(a=this.getByCid(e[n])||this.get(e[n]))&&(delete this._byId[a.id],delete this._byCid[a.cid],i=this.indexOf(a),this.models.splice(i,1),this.length--,t.silent||(t.index=i,a.trigger("remove",a,this,t)),this._removeReference(a));return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,t),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,o.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},get:function(e){return null==e?void 0:this._byId[null!=e.id?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return o.isEmpty(e)?[]:this.filter(function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},sort:function(e){if(e||(e={}),!this.comparator)throw Error("Cannot sort a set without a comparator");var t=o.bind(this.comparator,this);return 1==this.comparator.length?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return o.map(this.models,function(t){return t.get(e)})},reset:function(e,t){e||(e=[]),t||(t={});for(var n=0,r=this.models.length;r>n;n++)this._removeReference(this.models[n]);return this._reset(),this.add(e,o.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(t){t=t?o.clone(t):{},void 0===t.parse&&(t.parse=!0);var n=this,r=t.success;return t.success=function(e,i,o){n[t.add?"add":"reset"](n.parse(e,o),t),r&&r(n,e)},t.error=e.wrapError(t.error,n,t),(this.sync||e.sync).call(this,"read",this,t)},create:function(e,t){var n=this,t=t?o.clone(t):{},e=this._prepareModel(e,t);if(!e)return!1;t.wait||n.add(e,t);var r=t.success;return t.success=function(i,o){t.wait&&n.add(i,t),r?r(i,o):i.trigger("sync",e,o,t)},e.save(null,t),e},parse:function(e){return e},chain:function(){return o(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){return t||(t={}),e instanceof l?e.collection||(e.collection=this):(t.collection=this,e=new this.model(e,t),e._validate(e.attributes,t)||(e=!1)),e},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){("add"==e||"remove"==e)&&n!=this||("destroy"==e&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],this._byId[t.id]=t),this.trigger.apply(this,arguments))}}),o.each("forEach,each,map,reduce,reduceRight,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,sortBy,sortedIndex,toArray,size,first,initial,rest,last,without,indexOf,shuffle,lastIndexOf,isEmpty,groupBy".split(","),function(e){c.prototype[e]=function(){return o[e].apply(o,[this.models].concat(o.toArray(arguments)))}});var h=e.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},f=/:\w+/g,d=/\*\w+/g,p=/[-[\]{}()+?.,\\^$|#\s]/g;o.extend(h.prototype,u,{initialize:function(){},route:function(t,n,r){return e.history||(e.history=new g),o.isRegExp(t)||(t=this._routeToRegExp(t)),r||(r=this[n]),e.history.route(t,o.bind(function(i){i=this._extractParameters(t,i),r&&r.apply(this,i),this.trigger.apply(this,["route:"+n].concat(i)),e.history.trigger("route",this,n,i)},this)),this},navigate:function(t,n){e.history.navigate(t,n)},_bindRoutes:function(){if(this.routes){var e,t=[];for(e in this.routes)t.unshift([e,this.routes[e]]);e=0;for(var n=t.length;n>e;e++)this.route(t[e][0],t[e][1],this[t[e][1]])}},_routeToRegExp:function(e){return e=e.replace(p,"\\$&").replace(f,"([^/]+)").replace(d,"(.*?)"),RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var g=e.History=function(){this.handlers=[],o.bindAll(this,"checkUrl")},m=/^[#\/]/,v=/msie [\w.]+/;g.started=!1,o.extend(g.prototype,u,{interval:50,getHash:function(e){return(e=(e?e.location:window.location).href.match(/#(.*)$/))?e[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||t){var e=window.location.pathname,n=window.location.search;n&&(e+=n)}else e=this.getHash();return e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(m,"")},start:function(e){if(g.started)throw Error("Backbone.history has already been started");g.started=!0,this.options=o.extend({},{root:"/"},this.options,e),this._wantsHashChange=!1!==this.options.hashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.options.pushState||!window.history||!window.history.pushState);var e=this.getFragment(),t=document.documentMode;return(t=v.exec(navigator.userAgent.toLowerCase())&&(!t||7>=t))&&(this.iframe=a('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?a(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!t?a(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e,e=window.location,t=e.pathname==this.options.root,this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!t?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&t&&e.hash&&(this.fragment=this.getHash().replace(m,""),window.history.replaceState({},document.title,e.protocol+"//"+e.host+this.options.root+this.fragment)),this.options.silent?void 0:this.loadUrl())},stop:function(){a(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),g.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e==this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e==this.fragment?!1:(this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(e){var t=this.fragment=this.getFragment(e);return o.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0})},navigate:function(e,t){if(!g.started)return!1;t&&!0!==t||(t={trigger:t});var n=(e||"").replace(m,"");this.fragment!=n&&(this._hasPushState?(0!=n.indexOf(this.options.root)&&(n=this.options.root+n),this.fragment=n,window.history[t.replace?"replaceState":"pushState"]({},document.title,n)):this._wantsHashChange?(this.fragment=n,this._updateHash(window.location,n,t.replace),this.iframe&&n!=this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace))):window.location.assign(this.options.root+e),t.trigger&&this.loadUrl(e))},_updateHash:function(e,t,n){n?e.replace(e.toString().replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}});var y=e.View=function(e){this.cid=o.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},b=/^(\S+)\s*(.*)$/,_="model,collection,el,id,attributes,className,tagName".split(",");o.extend(y.prototype,u,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,n){return e=document.createElement(e),t&&a(e).attr(t),n&&a(e).html(n),e},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof a?e:a(e),this.el=this.$el[0],!1!==t&&this.delegateEvents(),this},delegateEvents:function(e){if(e||(e=S(this,"events"))){this.undelegateEvents();for(var t in e){var n=e[t];if(o.isFunction(n)||(n=this[e[t]]),!n)throw Error('Method "'+e[t]+'" does not exist');var r=t.match(b),i=r[1],r=r[2],n=o.bind(n,this),i=i+(".delegateEvents"+this.cid);""===r?this.$el.bind(i,n):this.$el.delegate(r,i,n)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=o.extend({},this.options,e));for(var t=0,n=_.length;n>t;t++){var r=_[t];e[r]&&(this[r]=e[r])}this.options=e},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var e=S(this,"attributes")||{};this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(this.tagName,e),!1)}}}),l.extend=c.extend=h.extend=y.extend=function(e,t){var n=k(this,e,t);return n.extend=this.extend,n};var w={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};e.sync=function(t,n,r){var i=w[t];r||(r={});var s={type:i,dataType:"json"};return r.url||(s.url=S(n,"url")||E()),r.data||!n||"create"!=t&&"update"!=t||(s.contentType="application/json",s.data=JSON.stringify(n.toJSON())),e.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),!e.emulateHTTP||"PUT"!==i&&"DELETE"!==i||(e.emulateJSON&&(s.data._method=i),s.type="POST",s.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",i)}),"GET"!==s.type&&!e.emulateJSON&&(s.processData=!1),a.ajax(o.extend(s,r))},e.wrapError=function(e,t,n){return function(r,i){i=r===t?i:r,e?e(t,i,n):t.trigger("error",t,i,n)}};var x=function(){},k=function(e,t,n){var r;return r=t&&t.hasOwnProperty("constructor")?t.constructor:function(){e.apply(this,arguments)},o.extend(r,e),x.prototype=e.prototype,r.prototype=new x,t&&o.extend(r.prototype,t),n&&o.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r},S=function(e,t){return e&&e[t]?o.isFunction(e[t])?e[t]():e[t]:null},E=function(){throw Error('A "url" property or function must be specified')}}.call(window),define("libs/backbone-min",function(){}),define("Backbone",["!libs/backbone-min"],function(){return window.Backbone}),define("Leaflet",[],function(){return window.L}),define("models/mapState",["Backbone"],function(e){return e.Model.extend({defaults:{lat:59.95,lon:30.3,z:10},initialize:function(){this.fetch()},fetch:function(){if(window.localStorage){var e=window.localStorage;e.lon&&e.lat&&e.z&&this.set({lon:e.lon,lat:e.lat,z:e.z})}},save:function(){if(window.localStorage){var e=window.localStorage;e.lon=this.get("lon"),e.lat=this.get("lat"),e.z=this.get("z")}}})}),define("models/mapStateItem",["models/mapState"],function(e){return new e}),Backbone.EventBroker=Backbone.EventBroker||function(){var e={},t=function(e,t,n,r){!t&&e.interests&&(t=e,e=e.interests);
for(var i in e)e.hasOwnProperty(i)&&n[r](i,t[e[i]],t);return n},n={register:function(e,n){return e||n?t(e,n,this,"on"):this},unregister:function(e,n){return e||n?t(e,n,this,"off"):this}};return _.extend({namespace:"",get:function(t){return void 0===e[t]&&(e[t]=_.extend({namespace:t},Backbone.Events,n)),e[t]},has:function(t){return void 0!==e[t]},destroy:function(t){if(t)e[t]&&(e[t].off(),delete e[t]);else for(t in e)e.hasOwnProperty(t)&&this.destroy(t);return this}},Backbone.Events,n)}(),define("BackboneEventBroker",["Backbone"],function(e){return function(){var t;return t||e.BackboneEventBroker}}(this)),define("EventBroker",["Backbone","BackboneEventBroker"],function(e){return e.EventBroker}),define("models/leafletMapObject",["Backbone","jQuery"],function(e){return new(e.Model.extend({my_map:null,initialize:function(){},setMap:function(e){this.my_map=e},getMap:function(){return this.my_map}}))}),define("views/mapView",["Backbone","jQuery","Leaflet","models/mapStateItem","EventBroker","models/leafletMapObject"],function(e,t,n,r,i,o){return e.View.extend({model:r,interests:{"map:setCenter":"mapSetCenterSignalHandler"},initialize:function(){var e=this.model;e.fetch(),e.on("change",e.save,e);var r=n.map("map",{center:[e.get("lat"),e.get("lon")],zoom:e.get("z"),maxZoom:19});o.setMap(r),r.on("moveend",function(){if(!e._update_from_change){var t=r.getCenter();e._update_from_map=!0,e.set({lon:t.lng,lat:t.lat,z:r.getZoom()}),delete e._update_from_map}}),e.on("change",function(){e._update_from_map||(e._update_from_change=!0,r.setView([e.get("lat"),e.get("lon")],e.get("z")),delete e._update_from_change)}),t("#map-page").bind("pageshow",function(){setTimeout(function(){r.invalidateSize()},0)}),i.register(this),n.control.scale().addTo(r)},mapSetCenterSignalHandler:function(e){this.model.set(e)}})}),define("detect/fullScreen",[],function(){return{hasFullScreenAPI:function(e){return!!(e.requestFullscreen||e.webkitRequestFullScreen||e.mozRequestFullScreen)},fullScreen:function(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen():e.mozRequestFullScreen&&e.mozRequestFullScreen()},exitFullScreen:function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()}}}),define("models/settingsItem",["Backbone","jQuery"],function(e){var t=new(e.Model.extend({defaults:{fullScreen:!1,base_layer_url:"http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"},initialize:function(){},save:function(){localStorage.settings=JSON.stringify(this.toJSON())},fetch:function(){localStorage.settings&&this.set(JSON.parse(localStorage.settings))}}));return t.fetch(),t.on("change",t.save,t),t}),define("views/fullScreenView",["Backbone","jQuery","detect/fullScreen","models/settingsItem"],function(e,t,n){return e.View.extend({events:{"click .goFullScreen":"goFullScreenClickHandler"},initialize:function(){this.setElement(t("body")[0]),n.hasFullScreenAPI(t("body")[0])&&this.$el.addClass("has-fullscreen")},goFullScreen:function(){t("body").fullScreen({callback:function(e){t("body")[e?"addClass":"removeClass"]("fullScreen")}})},goFullScreenClickHandler:function(){return this.goFullScreen(),!1}})}),define("models/currentPositionItem",["Backbone"],function(e){return new e.Model}),define("functions/distanceMeters",["Leaflet"],function(e){return function(t,n){var r=new e.LatLng(t.lat,t.lon);return r.distanceTo([n.lat,n.lon])}}),define("views/updateLocation",["Backbone","jQuery","EventBroker","models/currentPositionItem","functions/distanceMeters","models/mapStateItem"],function(e,t,n,r,i,o){return e.View.extend({model:r,initialize:function(){var e=this;navigator.geolocation&&navigator.geolocation.watchPosition(function(t){setTimeout(function(){e.model.set({lon:t.coords.longitude,lat:t.coords.latitude})},0)},function(){},{enableHighAccuracy:!0,maximumAge:0}),this.model.on("change",function(){var t=i(e.model.toJSON(),o.toJSON());if(t>20){var r=e.model.toJSON();o.get("z")<17&&(r.z=17),n.trigger("map:setCenter",r)}})}})}),define("views/currentPositionMarkerView",["Backbone","Leaflet","models/leafletMapObject","models/currentPositionItem"],function(e,t,n,r){return e.View.extend({my_marker:null,initialize:function(){var e=n.getMap(),i=this;r.on("change",function(){if(r.get("lat")){var n=[r.get("lat"),r.get("lon")];i.my_marker?i.my_marker.setLatLng(n).update():i.my_marker=new t.Marker(n).addTo(e)}})}})}),define("views/baseLayerView",["Backbone","Leaflet","models/leafletMapObject","models/settingsItem"],function(e,t,n,r){return e.View.extend({my_layer:null,initialize:function(){this.render(),r.on("change:base_layer_url",function(){var e=this;setTimeout(function(){e.render()},0)},this)},render:function(){var e=n.getMap();this.my_layer&&e.removeLayer(this.my_layer);var i=t.tileLayer(r.get("base_layer_url"),{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(e);this.my_layer=i}})}),function(){function e(e,t,n){n=l;var r="__p+='"+e.replace(d,function(e){return"\\"+h[e]}).replace(n.escape||c,function(e,t){return"'+_.escape("+g(t)+")+'"}).replace(n.interpolate||c,function(e,t){return"'+("+g(t)+")+'"}).replace(n.evaluate||c,function(e,t){return"';"+g(t)+";__p+='"})+"';";n.variable||(r="with(obj||{}){"+r+"}"),r="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};"+r+"return __p;";var i=new Function(n.variable||"obj","_",r);if(t)return i(t,_);var o=function(e){return i.call(this,e,_)};return o.source="function("+(n.variable||"obj")+"){"+r+"}",o}var t=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,r=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,i="undefined"!=typeof location&&location.href,o=i&&location.protocol&&location.protocol.replace(/\:/,""),a=i&&location.hostname,s=i&&(location.port||void 0),u=[],l={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},c=/.^/,h={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(var f in h)h[h[f]]=f;var d=/\\|'|\r|\n|\t|\u2028|\u2029/g,p=/\\(\\|'|r|n|t|u2028|u2029)/g,g=function(e){return e.replace(p,function(e,t){return h[t]})};define("tpl",[],function(){var l,c,h;return"undefined"!=typeof window&&window.navigator&&window.document?c=function(e,t){var n=l.createXhr();n.open("GET",e,!0),n.onreadystatechange=function(){4===n.readyState&&t(n.responseText)},n.send(null)}:"undefined"!=typeof process&&process.versions&&process.versions.node?(h=require.nodeRequire("fs"),c=function(e,t){t(h.readFileSync(e,"utf8"))}):"undefined"!=typeof Packages&&(c=function(e,t){var n,r,i="utf-8",o=new java.io.File(e),a=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(o),i)),u="";try{for(n=new java.lang.StringBuffer,r=s.readLine(),r&&r.length()&&65279===r.charAt(0)&&(r=r.substring(1)),n.append(r);null!==(r=s.readLine());)n.append(a),n.append(r);u=String(n.toString())}finally{s.close()}t(u)}),l={version:"1.0.0",strip:function(e){if(e){e=e.replace(n,"");var t=e.match(r);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")},createXhr:function(){var e,n,r;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;for(n=0;3>n;n++){r=t[n];try{e=new ActiveXObject(r)}catch(i){}if(e){t=[r];break}}if(!e)throw new Error("createXhr(): XMLHttpRequest not available");return e},get:c,parseName:function(e){var t=!1,n=e.indexOf("."),r=e.substring(0,n),i=e.substring(n+1,e.length);return n=i.indexOf("!"),-1!==n&&(t=i.substring(n+1,i.length),t="strip"===t,i=i.substring(0,n)),{moduleName:r,ext:i,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,t,n,r){var i,o,a,s=l.xdRegExp.exec(e);return s?(i=s[2],o=s[3],o=o.split(":"),a=o[1],o=o[0],!(i&&i!==t||o&&o!==n||(a||o)&&a!==r)):!0},finishLoad:function(t,n,r,i,o){r=n?l.strip(r):r;var a=e(r),s=a.source;o.isBuild&&o.inlineText&&(u[t]=s),i(a)},load:function(e,t,n,r){var u=l.parseName(e),c=u.moduleName+"."+u.ext,h=t.toUrl(c),f=r&&r.text&&r.text.useXhr||l.useXhr;!i||f(h,o,a,s)?l.get(h,function(t){l.finishLoad(e,u.strip,t,n,r)}):t([c],function(e){l.finishLoad(u.moduleName+"."+u.ext,u.strip,e,n,r)})},write:function(e,t,n){if(t in u){var r=u[t];n('define("'+e+"!"+t+'", function() { return '+r+"; });\n")}},writeFile:function(e,t,n,r,i){var o=l.parseName(t),a=o.moduleName+"."+o.ext,s=n.toUrl(o.moduleName+"."+o.ext)+".js";l.load(a,n,function(){var t=function(e){return r(s,e)};t.asModule=function(e,t){return r.asModule(e,s,t)},l.write(e,a,t,i)},i)}}})}(),define("tpl!templates/request.xml",function(){return function(obj){var __p="";with(obj||{})__p+='<?xml version="1.0" encoding="UTF-8"?>\n<osm-script>\n    <union>\n        <!-- buildings without building type -->\n        <query type="way">\n            <has-kv k="building" v="yes" />\n            <bbox-query s="'+south+'" w="'+west+'" n="'+north+'" e="'+east+'"/>\n        </query>\n        <!-- buildings without building levels -->\n        <query type="way">\n            <has-kv k="building" />\n            <has-kv k="building:levels" modv="not" regv="[0-9]" />\n            <bbox-query s="'+south+'" w="'+west+'" n="'+north+'" e="'+east+'"/>\n        </query>\n        <!-- houses without address number -->\n        <query type="way">\n            <has-kv k="building" v="house" />\n            <has-kv k="addr:housenumber" modv="not" regv="[0-9]" />\n            <bbox-query s="'+south+'" w="'+west+'" n="'+north+'" e="'+east+'"/>\n        </query>\n    </union>\n    <union>\n        <item/>\n        <recurse type="down"/>\n    </union>\n    <print mode="meta"/>\n</osm-script>\n';return __p}}),define("functions/osm2geo",[],function(){var e=function(e){function t(e){var t=new Array;return t.push(parseFloat(e.attr("minlon"))),t.push(parseFloat(e.attr("minlat"))),t.push(parseFloat(e.attr("maxlon"))),t.push(parseFloat(e.attr("maxlat"))),t}function n(e){var t={},n=$(e),r=n.find("tag");return r.each(function(e,n){t[$(n).attr("k")]=$(n).attr("v")}),"WAY"==e.tagName&&n.attr("id")&&n.attr("version")&&(t["osm:id"]="way:"+n.attr("id")+":"+n.attr("version")),t}function r(e,t){return{geometry:{type:t,coordinates:[]},type:"Feature",properties:n(e)}}var i=jQuery(e),o={type:"FeatureCollection",features:[]};o.bbox=t(i.find("bounds"));var a=$("way",i);a.each(function(e,t){var n=new Object,a=$(t).find("nd");$(a).last().attr("ref")===$(a).first().attr("ref")?(n=r(t,"Polygon"),n.geometry.coordinates.push([])):n=r(t,"LineString"),a.each(function(e,t){var r=i.find("node[id='"+$(t).attr("ref")+"']"),o=[parseFloat(r.attr("lon")),parseFloat(r.attr("lat"))];"Polygon"===n.geometry.type?n.geometry.coordinates[0].push(o):n.geometry.coordinates.push(o)}),o.features.push(n)});var s=$("node:has('tag')",i);return s.each(function(e,t){var n=r(t,"Point");n.geometry.coordinates.push(parseFloat($(t).attr("lon"))),n.geometry.coordinates.push(parseFloat($(t).attr("lat"))),o.features.push(n)}),o};return e}),define("views/dataLayerView",["Backbone","Leaflet","models/leafletMapObject","models/mapStateItem","tpl!templates/request.xml","functions/osm2geo","EventBroker"],function(e,t,n,r,i,o,a){var s={radius:2,fillColor:"#ff7800",color:"#000",weight:1,opacity:.5,fillOpacity:.5,clickable:!1};return e.View.extend({my_layer:null,my_selected_layer:null,my_request_bounds:null,initialize:function(){r.on("change",this.updateLayerIfNeed,this),this.updateLayerIfNeed()},updateLayerIfNeed:function(){var e=this,t=n.getMap(),r=t.getBounds();if(!this.my_request_bounds||!this.my_request_bounds.contains(r)){var a=r.getSouthWest(),s=a.distanceTo([r.getSouth(),r.getEast()]),u=a.distanceTo([r.getNorth(),r.getWest()]);if(!(s*u>4e5)){var l=r.pad(.3),c=i({south:l.getSouth(),north:l.getNorth(),east:l.getEast(),west:l.getWest()});this.my_request_bounds=l,$.ajax({type:"POST",url:"http://overpass-api.de/api/interpreter",data:c,dataType:"html",success:function(t){var n=o(t);e.render(n)}})}}},render:function(e){var r=n.getMap(),i=this;this.my_layer&&r.removeLayer(this.my_layer);var o=t.geoJson(e,{onEachFeature:function(e,t){t.on("click",function(){i.my_selected_layer&&i.my_selected_layer.setStyle(i.my_selected_layer.originalStyle),t.originalStyle=t.options,setTimeout(function(){a.trigger("map:featureSelect",e,t)},0),t.setStyle({color:"#0000ff",weight:8}),i.my_selected_layer=t})},pointToLayer:function(e,n){return t.circleMarker(n,s)}}).addTo(r);this.my_layer=o}})}),define("models/change",["Backbone","Underscore"],function(e){return e.Model.extend({initialize:function(){},setProperty:function(e,t){this.set(e,t)},getProperty:function(e){return this.get(e)||null},getOsmType:function(){return this.id.split(":")[0]},getOsmIdInt:function(){return this.id.split(":")[1]}})}),define("models/changesCollection",["Backbone","models/change","jQuery"],function(e,t,n){return e.Collection.extend({model:t,initialize:function(){},osm_server:"http://www.openstreetmap.org",osm_read_server:"http://www.openstreetmap.org",saveSimple:function(e,t){if(!this.length)return!1;var r=this;n.ajax({beforeSend:function(n){n.setRequestHeader("Authorization","Basic "+btoa(e+":"+t))},url:r.osm_server+"/api/0.6/changeset/create",type:"PUT",success:function(i){var o=0,a=0,s=function(){setTimeout(function(){var u=r.at(o);return u?(n.ajax({url:r.osm_read_server+"/api/0.6/"+u.getOsmType()+"/"+u.getOsmIdInt(),success:function(l){var c=n(l).children();c.children().attr("changeset",i),c.children().removeAttr("user"),c.children().removeAttr("uid");var h=c.html();_.chain(u.attributes).keys().each(function(e){if("id"!=e){var t=u.attributes[e];if(null===t)c.find('tag[k="'+e+'"]').remove();else{var n=c.find('tag[k="'+e+'"]');if(n.length)n.attr("v",t);else{var r=c.html();r=r.replace(/<\/way>/m,'<tag k="'+e+'" v="'+t+'" />'+"</way>"),c.html(r)}}}}),c.html()!=h?n.ajax({url:r.osm_server+"/api/0.6/changeset/"+i+"/upload",beforeSend:function(n){n.setRequestHeader("Authorization","Basic "+btoa(e+":"+t))},type:"POST",data:'<osmChange version="0.3" generator="Osmosis"><modify>'+c.html()+"</modify>"+"</osmChange>",success:function(){r.remove(u),a++,s()},error:function(){o++,s()}}):(r.remove(u),s())},error:function(){o++,s()}}),void 0):(a&&this.trigger("savedSimple"),void 0)},10)};s()},error:function(e){alert(e)},data:'<osm><changeset><tag k="created_by" v="OSM Mobile" /><tag k="comment" v="building changes" /></changeset></osm>'})},save:function(){(window.localStorage||{}).changes=JSON.stringify(this.toJSON())},fetch:function(){var e=(window.localStorage||{}).changes;e&&this.add(JSON.parse(e))}})}),define("models/changesCollectionItem",["models/changesCollection"],function(e){var t=new e;return t.fetch(),t.on("all",t.save,t),t}),define("views/settingsView",["Backbone","jQuery","models/settingsItem","models/changesCollectionItem"],function(e,t,n,r){return e.View.extend({events:{"change #base_layer_url":"changeHandler","change #auto_close_feature_page":"booleanSelectChangeHandler","click #goSaveToServer":"saveToServerClickHandler"},model:n,initialize:function(){this.setElement(t("#settings-page")),this.model.on("change",this.render,this),r.on("all",this.render,this),this.render()},render:function(){this._dont_render||(this.$("#base_layer_url").val(this.model.get("base_layer_url")),this.$("#auto_close_feature_page").val(this.model.get("auto_close_feature_page")?"true":"false"),r.length?this.$("#saveBlock").show().find("p > em").html(r.length):this.$("#saveBlock").hide())},changeHandler:function(e){var n=e.target;this._dont_render=!0,this.model.set(n.id,t(n).val()),delete this._dont_render},booleanSelectChangeHandler:function(e){var n=e.target;this._dont_render=!0;var r=t(n).val();this.model.set(n.id,"true"===r),delete this._dont_render},saveToServerClickHandler:function(){r.saveSimple(this.$("#osm_login").val(),this.$("#osm_password").val())}})}),define("tpl!templates/buildingDescription.html",function(){return function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="",_.chain(feature.properties).keys().each(function(e){"osm:id"!=e&&(print("<p>"),print("<b>"+e+"</b>: <i>"+feature.properties[e]+"</i>"),print("</p>"))}),__p+="\n";return __p}}),define("views/featureView",["Backbone","jQuery","EventBroker","models/change","models/changesCollectionItem","tpl!templates/buildingDescription.html","Underscore","models/settingsItem"],function(e,t,n,r,i,o,a,s){return e.View.extend({interests:{"map:featureSelect":"mapSelectFeatureSignalHandler"},my_feature:null,collection:i,events:{"change #buildingLevels":"buildingLevelsChangeHandler","change #buildingType":"buildingTypeChangeHandler","change #houseNumber":"houseNumberChangeHandler"},initialize:function(){n.register(this)},render:function(){this._rendering=!0,this.$(".buildingDescription").html(o({feature:this.my_feature,_:a})),this.$("#buildingLevels").val(this.getProperty("building:levels")||"").change(),this.$("#buildingType").val(this.getProperty("building")||"").change(),this.$("#houseNumber").val(this.getProperty("addr:housenumber")).change(),delete this._rendering},getProperty:function(e){var t=this.my_feature,n=t.properties[e],r=this.getFeatureId(t),i=this.collection.get(r);if(i){var o=i.getProperty(e);o&&(n=o)}return n},getFeatureId:function(e){return e||(e=this.my_feature),e.properties["osm:id"]},mapSelectFeatureSignalHandler:function(e){this.my_feature=e,this.setElement("#feature-page-content"),this.render(),t.mobile.changePage("#feature-page",{transition:"slide"})},setChange:function(e,t){var n=this.getFeatureId(),i=!1,o=this.collection.get(n)||function(){var e=new r;return e.set({id:n}),i=!0,e}();o.setProperty(e,""==t?null:t),i&&this.collection.add(o)},selectChangeHandler:function(e,n){if(!this._rendering){var r=t(e.target).val();this.setChange(n,r),this.allUserChangesHanler()}},buildingLevelsChangeHandler:function(e){this.selectChangeHandler(e,"building:levels")},buildingTypeChangeHandler:function(e){this.selectChangeHandler(e,"building")},houseNumberChangeHandler:function(e){if(!this._rendering){var n=t(e.target).val();this.setChange("addr:housenumber",n),this.allUserChangesHanler()}},allUserChangesHanler:function(){this._rendering||s.get("auto_close_feature_page")&&this.getProperty("addr:housenumber")&&this.getProperty("building:levels")&&"yes"!=this.getProperty("building")&&t.mobile.changePage("#map-page",{transition:"slide"})}})}),define("app",["views/mapView","views/fullScreenView","views/updateLocation","views/currentPositionMarkerView","views/baseLayerView","views/dataLayerView","views/settingsView","views/featureView"],function(e,t,n,r,i,o,a,s){var u=function(){new e,new i,new o,new t,new n,new r,new a,new s};return{initialize:u}}),require.config({baseUrl:"js",paths:{tpl:"libs/tpl",models:"models",views:"views",jQuery:"jQuery.from.window",Leaflet:"Leaflet.from.window",Backbone:"libs/backbone",Underscore:"libs/underscore",EventBroker:"libs/event-broker-debug",BackboneEventBroker:"libs/backbone-eventbroker",templates:"../templates"},shim:{Underscore:{deps:["jQuery"],exports:"Underscore"},Backbone:{deps:["Underscore","jQuery"],exports:"Backbone"},BackboneEventBroker:{deps:["Backbone"],exports:"BackboneEventBroker"}}}),require(["app","jQuery"],function(e,t){t(document).ready(e.initialize)}),define("main",function(){})});